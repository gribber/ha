- alias: "Water meter: flow"
  id: 191c227f-0822-4457-b917-539d9345eb48
  triggers:
    - trigger: numeric_state
      entity_id:
        - sensor.watermeter_water_usage_current
      above: 0
      for:
        minutes: 15
      id: flow_15

  variables:
    data: &notify_data
      importance: high
      ttl: 0
      #persistent: true
      tag: water_leak
      sticky: true
      visibility: public

  actions:
    - choose:
        - conditions:
            - condition: trigger
              id: flow_15
          sequence:
            - action: notify.family
              data_template:
                title: "Vattenflöde!"
                message: "Vatten har runnit i över 15min (flöde {{states('sensor.watermeter_water_usage_current')|round(2)}}L/min)"
                data: *notify_data
            - action: notify.castle
              data:
                title: "Vattenflöde!"
                message: "Vatten har runnit i över 15min (flöde {{states('sensor.watermeter_water_usage_current')|round(2)}}L/min)"
