- alias: "Annie: error"
  id: b3c00dc3-b327-498e-9076-8ab6ed4fb3b7
  mode: queued
  trace:
    stored_traces: 10

  trigger:
    - platform: state
      entity_id:
        - sensor.am430x_status_id
      to:
        - "7"
      not_from:
        - "unknown"
        - "unavailable"
        - "0" # 0 = please wait

  action:
    - delay:
        seconds: 1

    - service: notify.castle
      data:
        title: " "
        message: " "
        data:
          photo:
            - url: "https://ha.regerar.se{{ state_attr('image.annie_map', 'entity_picture') }}"
              caption: "Annie: {{states('sensor.am430x_status')}} - {{ states('input_text.annie_last_substatus') if states('sensor.am430x_substatus') == '' else states('sensor.am430x_substatus') }}"

- alias: "Annie: set last substatus"
  id: 0819562f-9de5-4c95-990f-f44f88e0e381
  mode: queued
  trace:
    stored_traces: 10

  trigger:
    - platform: state
      entity_id:
        - sensor.am430x_substatus
  action:
    service: input_text.set_value
    target:
      entity_id: input_text.annie_last_substatus
    data:
      value: "{{ trigger.from_state.state }}"
